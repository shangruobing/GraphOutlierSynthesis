# 论文大纲

## 动机

图分布外数据检测通常缺少分布外数据样本，如果只有分布内数据，只能随机划分分布内数据作为异常值，通常不能准确描述分布外数据的特点。因此，一种以分布内数据为数据源，以最邻近距离的点的能量值为判断的合成方法被提出，用于解决分布外数据缺少时，提高模型分布外数据检测的能力。

## 目的

以原有分布内数据为基础，使用最邻近的距离的能量值，判断是否合适作为合成点，用这种新型的算法改进图分布外数据检测任务的效果。

## 方法

1. **识别临界数据，探测分布边缘**

   图训练数据中最接近边界的一些数据，称之为临界数据。当收集足够的临界数据，可以分析出训练数据中的数据分布情况，探测到数据分布的边缘。
   **判断图训练数据中的边界是**通过KNN算法查找到每个点及其相邻的K个邻居。通过选取每个点与其最远的、第K个邻居，得到整个图数据中，距离最大的N个距离对。将对这N个距离对进行排序，得到了图训练数据中的边界。

2. **合成分布外数据**

   根据临界数据的分布，根据正态分布概率，合成新的数据，这些数据在临界数据周围，但是不属于原来训练集中的数据，这些数据称之为合成的分布外数据，
   **合成分布外的数据的详细步骤如下：**

    1. 找出数据集内每个元素最边界的k个元素，再从中挑取top个，做到挑选整个数据集最边界的元素。

    2. 假设每个边界元素贡献10个分布外点，从正态分布中随机采样作为噪声，将这些噪声添加入分布外点中，得到分布外点集合。

    3. 将分布外点集合再次进行向量搜索，再次选取最边界的元素(这步目的是避免添加入噪声的边界数据更靠近数据中心)，筛选完成的元素再使用正态分布添加噪声，从而得到负样本点(nosies = torch.cat([torch.rand_like(outliers) * -0.05, torch.rand_like(outliers) * 0.05]))。

    4. 对于分布外数据的边，通过计算分布内数据中的边点比(边的数目//节点的数目)，生成对应数目的边，从而随机连通两个节点。

    5. 对于分布外数据的标签/类别，由于不将其带入监督训练过程，假设Label全为0

3. **能量过滤器**

   合成的分布外数据需要经过筛选，才能构建新的训练集投入模型训练。因此需要一个判别器来评估合成数据的质量，首先将合成点通过能量函数赋予能量值，将能量值放入判别器中，区分分布内数据和分布外数据的，对合成数据进行评估筛选，同时判别器进行自我更新。

4. **图能量网络训练**
   
   将合成的分布外数据作为少量异常值数据，与正常的训练集数据结合形成新的训练集。图神经网络采用能量函数作为损失函数，对新的训练集进行拟合，达到分布外数据识别的能力。

## 亮点

- 处理分布外数据检测任务，不需要额外提供分布外数据
- 对于分布外数据检测任务，有效提高分布外数据检测能力
- 能与多种分布外数据检测任务方法相融合

## 同类方法

略

## 证明方法

略

## 摘要

## 背景

## 相关研究

## 问题定义

## 提出方法

在图训练任务中，每一次训练数据的输入，会在图网络上进行一次卷积操作，使得原有节点的值向着卷积中心的节点传播，而达到全图节点值更新的效果。

```math
Z^{(l)}=\sigma\left(D^{-1 / 2} \tilde{A} D^{-1 / 2} Z^{(l-1)} W^{(l)}\right), \quad Z^{(l-1)}=\left[\mathbf{z}_i^{(l-1)}\right]_{i \in \mathcal{I}}, \quad Z^{(0)}=X,
```

其中$`\tilde{A} `$是自环邻接矩阵，$`D`$是对角度矩阵，$`W^{(l)}`$是权重矩阵，$`\sigma `$ 是一个非线性的激活函数，$`l`$是全网络卷积的次数（也可以看作是卷积层数）。

于是，图网络卷积过后的输出结果，等于是嵌入值，整个训练集可以表达为：

$$
\mathbb{Z}=\left({Z^{(l)}_1},{Z^{(l)}_1}, \dots {Z^{(l)}_n}\right)
$$

对于$` \mathbb{Z}`$任何嵌入值 $Z$,可以计算它的距离

$$
d_k\left(\mathbf{Z^{\prime}}, \mathbb{Z}\right)=\left| {Z}^{\prime} - {Z}_{(k)} \right|_2
$$

通过以上的方式，可以获得了关于分布内的临界数据集合$`h(X_i) \in \mathbb{B} `$，使用多元高斯分布采样方法，获得$`V`$ 合成点集合，其中$` \sigma^2`$是调节方差。
```math
\mathbf{V} \sim \mathcal{N}(h(X_i), \sigma^2 \mathbf{I})
```

上面提到，每个节点的输出（嵌入值）为$`Z_i^{(l)}`$，假设$`h`$为模型，而$`\theta`$模型参数，$` \mathcal{G}`$为预测函数，针对每个输入$`X_i`$做出预测，等价于$`h_\theta (X_i, \mathcal{G}_{x_i})`$，加入了$`softmax`$函数后，可以得出分布类别概率公式
```math
p\left(y \mid \mathbf{x}, \mathcal{G}_{\mathbf{x}}\right)=\frac{e^{h_\theta\left(\mathbf{x}, \mathcal{G}_{\mathbf{x}}\right)_{[y]}}}{\sum_{c=1}^C e^{h_\theta\left(\mathbf{x}, \mathcal{G}_{\mathbf{x}}\right)_{[c]}}} .
```

通过基于EMB能量密度函数和概率分布函数的联合（另附推导），可以将公式转为：
```math
E\left(\mathbf{x}, \mathcal{G}_{\mathbf{x}} ; h_\theta\right)=-\log \sum_{c=1}^C e^{h_\theta\left(\mathbf{x}, \mathcal{G}_{\mathbf{x}}\right)_{[c]}}
```

有了将输出值转化为能量值的连接方式后，将合成点集合$`V`$通过$`E\left(\mathbf{x}, \mathcal{G}_{\mathbf{x}} ; h_\theta\right)`$形成能量合成集合：
```math
\mathbb{E_V}=\left({E^{(l)}_1},{E^{(l)}_2}, \dots {E^{(l)}_n}\right)
```

最后将能量合成集合放入判别模型中进行过滤，筛选后的集合为$`V_f`$
```math
V_f  \sim \mathcal{N}(D\left( \mathbb{E_V};\delta \right))
```
同时将$`V_f`$放入模型进行自有监督训练，获得误差为



## 实验

1. 获取GNN对ID数据的输出，得到监督学习loss。
2. 使用ID输出和OOD输出计算Energy ID和Energy OOD。
3. 如果使用能量传播，则进一步处理Energy ID和Energy OOD。
4. 计算正则化能量分数energy regularization loss
5. 使用ID和OOD训练分类器，使用Energy过滤合成的数据(可选)，得到分类器classifier loss

loss = 图监督学习supervised learning loss + 正则化能量分数energy regularization loss + 分类器classifier loss

loss = supervised learning loss + energy regularization loss + classifier loss

### 数据集

数据集完全采用torch_geometric提供的Planetoid, Amazon, Coauthor, Twitch, WikiCS, Actor, WebKB, GitHub等公开数据集。

### 基线模型

"msp" "OE" "ODIN" "Mahalanobis" "maxlogits" "energymodel" "energyprop" 

### 编码器选择

"mlp" "sgc" "gcn" "gat" "mixhop" "gcnjk" "gatjk" "H2GCNConv" "APPNP_Net" "GPRPROP" "GPRGNN"

### 评价指标

- AUROC
- AUPR
- FPR
- ACCURACY
- SCORE

### 对比实验
- 与基线模型对比
- 与其他数据增强方法对比（待补充）

### 消融实验

- 是否使用合成点
- 是否使用经过过滤后的合成点
- 是否使用能量传播

### 实验素材
#### 表格
1. 实验数据集描述（节点、边、数量）
2. 与基线模型对比实验表格

#### 表格
1. 合成点数据分布图
   
